<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SpeakEZ App</title>
</head>
<body>

  <input id="audio_file" type="file" accept="audio/*" />
  <!-- <input id="fileInput" type="file" accept=".mp3, .wav" /> -->

  <button id="button_play">プレイ<br />play</button>

  <button id="button_repeat">リピート開始<br />start-point</button>

  <input id="slider_shadow_volume" type="range" min="0" max="1" step="any" value="0" />

  <script>
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();

    let audioBufferSourceNode;
    let isPlaying = false;

    let repeatCount = 0;
    let repeatBegin = 0;
    let repeatEnd = 0;

    const gainNode = audioContext.createGain();
    let is_mute = false;

    let shadow_volume = 0;
    const slider_shadow_volume = document.querySelector("#slider_shadow_volume");
    shadow_volume = slider_shadow_volume.value;
    slider_shadow_volume.addEventListener("input", (event) => {
	shadow_volume = event.target.value;

	if (!is_mute) {
	    gainNode.gain.value = shadow_volume
	}
    });

    // ファイルが選択されたときの処理
    document.getElementById('audio_file').addEventListener('change', function (event) {
	const audio_file = event.target;
	const file = audio_file.files[0];

	// ファイルを読み込む
	const reader = new FileReader();
	reader.onload = function (e) {
            // 読み込んだデータを再生するためのAudioBufferに変換
            audioContext.decodeAudioData(e.target.result, function (buffer) {
		// 既に再生中の場合は停止
		if (audioBufferSourceNode) {
		    audioBufferSourceNode.stop();
		    audioBufferSourceNode.disconnect();
		}

		// AudioBufferSourceNodeを作成
		audioBufferSourceNode = audioContext.createBufferSource();
		audioBufferSourceNode.buffer = buffer;
		audioBufferSourceNode.connect(audioContext.destination);

		audioBufferSourceNode.loop = true;

		audioBufferSourceNode.start();
		audioContext.suspend();
            });
	};

	// ファイルをArrayBufferとして読み込む
	reader.readAsArrayBuffer(file);
    });

    document.getElementById('button_play').addEventListener('click', function (event) {
	if (isPlaying != true) {
	    audioContext.resume();
	    isPlaying = true;
	    event.target.innerHTML = "一時停止<br />pause";
	} else {
	    audioContext.suspend();
	    isPlaying = false;
	    event.target.innerHTML = "プレイ<br />play";
	}
    });

    function onended_for_the_loop(oldNode) {
	oldNode.stop();
	oldNode.disconnect();

	audioBufferSourceNode = audioContext.createBufferSource();
	audioBufferSourceNode.buffer = oldNode.buffer;

	//audioBufferSourceNode.connect(audioContext.destination);
	gainNode.connect(audioContext.destination);
	audioBufferSourceNode.connect(gainNode);

	if (is_mute) {
	    gainNode.gain.value = shadow_volume
	    is_mute = false;
	} else {
	    gainNode.gain.value = 1;
	    is_mute = true;
	}

	audioBufferSourceNode.start(0, repeatBegin, repeatEnd - repeatBegin);

	audioBufferSourceNode.onended = function () {
	    onended_for_the_loop(this);
	}
    }

    document.getElementById('button_repeat').addEventListener('click', function (event) {
	if (audioBufferSourceNode && isPlaying) {
            const currentTime = audioContext.currentTime;

	    if (repeatCount == 0) {
		repeatBegin = currentTime;
		repeatCount += 1;
		event.target.innerHTML = "リピート終了<br />end-point";
	    } else if (repeatCount == 1) {
		repeatEnd = currentTime;
		repeatCount += 2;
		event.target.disabled = true;
		//event.target.innerHTML = "リピート解除<br />reset";

		onended_for_the_loop(audioBufferSourceNode);
		/*
	    } else {
		event.target.innerHTML = "リピート開始<br />start-point";
		repeatCount = 0;
		repeatBegin = 0;
		repeatEnd = 0;

		audioBufferSourceNode.removeEventListener('ended', onended_for_the_loop);

		let oldNode = audioBufferSourceNode;
		oldNode.stop();
		oldNode.disconnect();

		audioBufferSourceNode = audioContext.createBufferSource();
		audioBufferSourceNode.buffer = oldNode.buffer;

		audioBufferSourceNode.connect(audioContext.destination);
		audioBufferSourceNode.loop = true;

		//audioBufferSourceNode.start(currentTime);
		audioBufferSourceNode.start();
		audioContext.suspend();
		isPlaying = false;
		document.getElementById('button_play').innerHTML = "プレイ<br />play";
		*/
	    }
	}
    });
  </script>

</body>
</html>
